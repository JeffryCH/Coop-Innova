<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Solicitudes de Crédito - Coop-Innova</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="css/estilo.css" />
</head>
<body class="bg-light">
  <div id="loader-bg"><div class="loader-spinner"></div></div>

  <!-- Navbar importado -->
  <div id="navbar"></div>

  <div class="container pt-5 mt-5">
    <h2 class="mb-4 text-primary">Solicitudes de Crédito</h2>

    <table class="table table-striped bg-white rounded shadow-sm">
      <thead>
        <tr>
          <th>Cliente</th>
          <th>Monto Solicitado</th>
          <th>Estado</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="creditTableBody">
        <!-- Las filas se cargarán dinámicamente -->
      </tbody>
    </table>

    <div id="message" class="mt-3"></div>
  </div>

    <!-- Historial de créditos aprobados/denegados -->
    <div class="container mt-5 p-4 bg-white rounded shadow-sm border">
      <h3 class="mb-4 text-secondary">Historial de Créditos Aprobados/Denegados</h3>
      <table class="table table-bordered">
        <thead>
          <tr>
            <th>Cliente</th>
            <th>Monto</th>
            <th>Estado</th>
            <th>Fecha</th>
          </tr>
        </thead>
        <tbody id="creditHistoryBody">
          <!-- Historial dinámico -->
        </tbody>
      </table>
    </div>

  <div id="footer" class="mt-5"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="js/includes.js"></script>
  <script>
    const messageDiv = document.getElementById('message');
    const tableBody = document.getElementById('creditTableBody');

    // Cargar solicitudes de crédito desde la API
    function cargarSolicitudes() {
      fetch('php/creditos_api.php')
        .then(res => res.json())
        .then(data => {
          tableBody.innerHTML = '';
          const historyBody = document.getElementById('creditHistoryBody');
          historyBody.innerHTML = '';
          // Tabla principal: solo pendientes
          if (data.success && data.creditos.length > 0) {
            data.creditos.forEach(credito => {
              const row = document.createElement('tr');
              row.innerHTML = `
                <td>${credito.cliente}</td>
                <td>₡${parseFloat(credito.monto).toLocaleString('es-CR', {minimumFractionDigits:2})}</td>
                <td class="estado">${credito.estado}</td>
                <td>
                  <button class="btn btn-success btn-sm aprobar" data-id="${credito.id}">Aprobar</button>
                  <button class="btn btn-danger btn-sm denegar" data-id="${credito.id}">Denegar</button>
                </td>
              `;
              tableBody.appendChild(row);
            });
          } else {
            tableBody.innerHTML = '<tr><td colspan="4">No hay solicitudes de crédito.</td></tr>';
          }
          // Historial: aprobados y rechazados
          if (data.success && data.historial.length > 0) {
            data.historial.forEach(credito => {
              const row = document.createElement('tr');
              row.innerHTML = `
                <td>${credito.cliente}</td>
                <td>₡${parseFloat(credito.monto).toLocaleString('es-CR', {minimumFractionDigits:2})}</td>
                <td class="estado">${credito.estado}</td>
                <td>${new Date(credito.fecha).toLocaleString()}</td>
              `;
              historyBody.appendChild(row);
            });
          } else {
            historyBody.innerHTML = '<tr><td colspan="4">No hay historial de créditos.</td></tr>';
          }
        });
    }

    cargarSolicitudes();

    tableBody.addEventListener('click', function (e) {
      if (e.target.classList.contains('aprobar') || e.target.classList.contains('denegar')) {
        const id = e.target.getAttribute('data-id');
        const accion = e.target.classList.contains('aprobar') ? 'aprobar' : 'denegar';
        fetch('php/creditos_api.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: `id=${id}&accion=${accion}`
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            cargarSolicitudes();
            messageDiv.innerHTML = `<div class="alert alert-${accion === 'aprobar' ? 'success' : 'warning'}">Solicitud ${accion === 'aprobar' ? 'aprobada y monto acreditado.' : 'denegada.'}</div>`;
          } else {
            messageDiv.innerHTML = `<div class="alert alert-danger">${data.error || 'Error al actualizar.'}</div>`;
          }
        });
      }
    });
  </script>
</body>
</html>
