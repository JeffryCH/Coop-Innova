<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tipo de Cambio - Coop-Innova</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .tipo-cambio-widget {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,123,255,0.3);
            margin: 20px 0;
        }
        .currency-rate {
            font-size: 1.5rem;
            font-weight: bold;
            margin: 10px 0;
        }
        .update-time {
            font-size: 0.8rem;
            opacity: 0.8;
        }
        .refresh-btn {
            margin-top: 15px;
        }
        .loading {
            opacity: 0.6;
        }
    </style>
</head>
<body>
    <!-- Navbar importado -->
    <div id="navbar"></div>
    
    <!-- Modal de conversi√≥n importado -->
    <div id="modal-conversion-container"></div>
    
    <div class="container mt-5" style="padding-top: 80px;">
        <h1 class="text-center mb-4">üí± Tipo de Cambio - Banco Popular</h1>
        
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div id="tipoCambioWidget" class="tipo-cambio-widget">
                    <h3>üè¶ Banco Popular y de Desarrollo Comunal</h3>
                    <div class="row">
                        <div class="col-6">
                            <h5>üí∞ Compra</h5>
                            <div id="compra" class="currency-rate">--</div>
                        </div>
                        <div class="col-6">
                            <h5>üí∏ Venta</h5>
                            <div id="venta" class="currency-rate">--</div>
                        </div>
                    </div>
                    <div id="ultimaActualizacion" class="update-time">Cargando...</div>
                    <button id="refreshBtn" class="btn btn-light refresh-btn" onclick="actualizarTipoCambio()">
                        üîÑ Actualizar
                    </button>
                </div>
                
                <div class="alert alert-info mt-4">
                    <h5>‚ÑπÔ∏è Informaci√≥n</h5>
                    <p>Los tipos de cambio se obtienen directamente del Banco Central de Costa Rica (BCCR) y se actualizan autom√°ticamente cada 30 minutos.</p>
                    <p><strong>API Endpoint:</strong> <code>GET /api/tipo-cambio</code></p>
                </div>
                
                <div class="mt-4 text-center">
                    <a href="/" class="btn btn-primary">üè† Volver al Inicio</a>
                    <a href="/api/tipo-cambio" class="btn btn-outline-secondary" target="_blank">üìä Ver API JSON</a>
                </div>
            </div>
        </div>
    </div>

    <script>
        let actualizandoAuto = true;

        async function actualizarTipoCambio() {
            const widget = document.getElementById('tipoCambioWidget');
            const refreshBtn = document.getElementById('refreshBtn');
            
            // Mostrar estado de carga
            widget.classList.add('loading');
            refreshBtn.disabled = true;
            refreshBtn.innerHTML = '‚è≥ Actualizando...';
            
            try {
                const response = await fetch('/php/tipo_cambio_popular.php');
                const apiResponse = await response.json();
                console.log('üì° Respuesta API tipo-cambio:', apiResponse);
                if (apiResponse.success && apiResponse.data) {
                    const tipoCambioData = apiResponse.data;
                    document.getElementById('compra').textContent = `‚Ç°${tipoCambioData.compra.toFixed(2)}`;
                    document.getElementById('venta').textContent = `‚Ç°${tipoCambioData.venta.toFixed(2)}`;
                    document.getElementById('ultimaActualizacion').textContent = `√öltima actualizaci√≥n: ${tipoCambioData.fecha}`;
                } else {
                    console.error('‚ùå Estructura de datos inesperada en tipo-cambio:', apiResponse);
                    throw new Error('No se pudieron obtener los datos');
                }
                
            } catch (error) {
                console.error('Error al obtener tipo de cambio:', error);
                document.getElementById('compra').textContent = 'Error';
                document.getElementById('venta').textContent = 'Error';
                document.getElementById('ultimaActualizacion').textContent = 
                    'Error al conectar con el servidor';
            } finally {
                // Quitar estado de carga
                widget.classList.remove('loading');
                refreshBtn.disabled = false;
                refreshBtn.innerHTML = 'üîÑ Actualizar';
            }
        }

        // Actualizar autom√°ticamente cada 5 minutos
        function iniciarActualizacionAutomatica() {
            actualizarTipoCambio(); // Primera carga
            
            setInterval(() => {
                if (actualizandoAuto) {
                    console.log('Actualizando tipo de cambio autom√°ticamente...');
                    actualizarTipoCambio();
                }
            }, 5 * 60 * 1000); // 5 minutos
        }

        // Iniciar cuando se carga la p√°gina
        document.addEventListener('DOMContentLoaded', iniciarActualizacionAutomatica);

        // Pausar actualizaci√≥n autom√°tica cuando se va la pesta√±a
        document.addEventListener('visibilitychange', () => {
            actualizandoAuto = !document.hidden;
        });
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/includes.js"></script>
</body>
</html>
