<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Realizar Movimiento - Coop-Innova</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/estilo.css">
</head>
<body class="bg-light">
  <div id="navbar"></div>
  <div class="container pt-5 mt-5">
    <h2 class="text-center text-primary mb-4">Realizar Movimiento</h2>
    <div id="saldo-usuario" class="mb-4"></div>
    <div id="form-movimiento-container"></div>
  </div>
  <div id="footer" class="mt-5"></div>
  <script src="js/includes.js"></script>
  <script>
    async function cargarSaldoYFormulario() {
      const saldoDiv = document.getElementById('saldo-usuario');
      const formDiv = document.getElementById('form-movimiento-container');
      let sesion;
      try {
        sesion = await fetch('php/session.php', { credentials: 'include' }).then(r => r.json());
      } catch (e) { sesion = { user: null }; }
      if (!sesion.user || !sesion.user.id) {
        saldoDiv.innerHTML = '<div class="alert alert-warning">Debes iniciar sesión para realizar movimientos.</div>';
        formDiv.innerHTML = '';
        return;
      }
      // Obtener saldo actual
      let saldo = 0;
      try {
        const resp = await fetch('php/saldo_usuario.php', { credentials: 'include' });
        const data = await resp.json();
        if (data.success) saldo = parseFloat(data.saldo);
      } catch (e) {}
      if (saldo <= 0) {
        saldoDiv.innerHTML = '<div class="alert alert-danger">Sin saldo disponible en la cuenta.</div>';
        formDiv.innerHTML = '';
        return;
      }
      saldoDiv.innerHTML = `<div class='alert alert-info'>Saldo disponible: <strong>₡${saldo.toLocaleString('es-CR', { minimumFractionDigits: 2 })}</strong></div>`;
      formDiv.innerHTML = `
        <form id='form-movimiento' class='card p-3 mb-3'>
          <h5 class='mb-3'>Selecciona el tipo de movimiento</h5>
          <div class='mb-3'>
            <select class='form-select' id='tipo-movimiento' required>
              <option value='retiro'>Retiro</option>
              <option value='transferencia'>Transferencia entre cuentas</option>
              <option value='pago_servicio'>Pago de servicios</option>
            </select>
          </div>
          <div class='mb-3'>
            <label for='monto' class='form-label'>Monto</label>
            <input type='number' class='form-control' id='monto' min='1' step='0.01' required>
          </div>
          <div class='mb-3' id='extra-campos'></div>
          <button type='submit' class='btn btn-success'>Realizar movimiento</button>
          <div id='mensaje-movimiento' class='mt-3'></div>
        </form>
      `;
      // Campos extra para transferencia y pago de servicios
      document.getElementById('tipo-movimiento').addEventListener('change', async function() {
        const extra = document.getElementById('extra-campos');
        if (this.value === 'transferencia') {
          // Obtener lista de usuarios
          let usuarios = [];
          try {
            const resp = await fetch('php/usuarios_lista.php', { credentials: 'include' });
            const data = await resp.json();
            if (data.success && data.usuarios) usuarios = data.usuarios;
          } catch (e) {}
          let options = usuarios.map(u => `<option value='${u.id}'>${u.nombre} (${u.usuario})</option>`).join('');
          extra.innerHTML = `<label for='cuenta-destino' class='form-label'>Cuenta destino</label><select class='form-select' id='cuenta-destino' required>${options}</select>`;
        } else if (this.value === 'pago_servicio') {
          extra.innerHTML = `<label for='servicio' class='form-label'>Servicio</label><input type='text' class='form-control' id='servicio' required>`;
        } else {
          extra.innerHTML = '';
        }
      });
      // Enviar movimiento
      document.getElementById('form-movimiento').onsubmit = async function(e) {
        e.preventDefault();
        const tipo = document.getElementById('tipo-movimiento').value;
        const monto = parseFloat(document.getElementById('monto').value);
        let body = `tipo=${encodeURIComponent(tipo)}&monto=${encodeURIComponent(monto)}`;
        if (tipo === 'transferencia') {
          body += `&cuenta_destino=${encodeURIComponent(document.getElementById('cuenta-destino').value)}`;
        }
        if (tipo === 'pago_servicio') {
          body += `&servicio=${encodeURIComponent(document.getElementById('servicio').value)}`;
        }
        const res = await fetch('php/realizar_movimiento.php', {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body
        });
        const data = await res.json();
        const msg = document.getElementById('mensaje-movimiento');
        if (data.success) {
          msg.className = 'mt-3 alert alert-success';
          msg.textContent = 'Movimiento realizado correctamente.';
          document.getElementById('form-movimiento').reset();
        } else {
          msg.className = 'mt-3 alert alert-danger';
          msg.textContent = data.error || 'Error al realizar movimiento.';
        }
      };
    }
    document.addEventListener('DOMContentLoaded', cargarSaldoYFormulario);
  </script>
</body>
</html>
