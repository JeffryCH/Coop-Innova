<nav class="navbar navbar-expand-lg navbar-light bg-light">
  <div class="container">
    <a class="navbar-brand fw-bold" href="index.html">🏦 Coop-Innova</a>
    
    <!-- Tipo de cambio en navbar -->
    <div id="tipo-cambio-navbar" class="d-flex align-items-center ms-3" style="font-size:0.85rem;">
      <div class="tipo-cambio-container d-flex gap-3">
        <div class="tipo-cambio-item" style="background:#e3f2fd; padding:4px 8px; border-radius:8px; border:1px solid #1976d2;">
          <span style="color:#1976d2; font-weight:600;">💵 USD:</span>
          <span id="navbar-usd-compra" style="color:#2e7d32; font-weight:500;">--</span> /
          <span id="navbar-usd-venta" style="color:#d32f2f; font-weight:500;">--</span>
        </div>
        <div class="tipo-cambio-item" style="background:#f3e5f5; padding:4px 8px; border-radius:8px; border:1px solid #7b1fa2;">
          <span style="color:#7b1fa2; font-weight:600;">💶 EUR:</span>
          <span id="navbar-eur-compra" style="color:#2e7d32; font-weight:500;">--</span> /
          <span id="navbar-eur-venta" style="color:#d32f2f; font-weight:500;">--</span>
        </div>
        <button id="btn-conversor" class="btn btn-sm btn-outline-primary" style="padding:2px 8px; font-size:0.8rem;" onclick="abrirConversor()">
          💱 Convertir
        </button>
      </div>
    </div>

    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#menu">
      <span class="navbar-toggler-icon"></span>
    </button>
    
    <div class="collapse navbar-collapse" id="menu">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link" href="index.html">🏠 Inicio</a></li>
        <li class="nav-item"><a class="nav-link" href="servicios.html">🛠️ Servicios</a></li>
        <li class="nav-item"><a class="nav-link" href="solicitar_credito.html">💳 Solicitar Crédito</a></li>
  <!-- Opción de Ver Perfil eliminada, ahora solo aparece en el menú de usuario dinámico -->
        <li class="nav-item"><a class="nav-link" href="tipo-cambio.html">💱 Tipo de Cambio</a></li>
        <li class="nav-item"><a class="nav-link" href="contacto.html">📞 Contacto</a></li>
  <!-- Botón de conversor eliminado, solo queda el principal junto al tipo de cambio -->
        <li class="nav-item" data-auth-item>
          <a class="nav-link" href="login.html">Iniciar sesión</a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<!-- Estilos para el navbar -->
<style>
.tipo-cambio-container {
  animation: fadeIn 1s ease-in;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

/* Responsive design */
@media (max-width: 768px) {
  #tipo-cambio-navbar {
    display: none !important;
  }
}
</style>

<!-- Script para tipo de cambio -->
<script>
console.log('🚀 Script de navbar cargando...');

// Variables globales
window.tipoCambioNavbar = {
  usd: { compra: 0, venta: 0 },
  eur: { compra: 0, venta: 0 }
};

// Función principal de actualización
async function actualizarTipoCambio() {
  console.log('🔄 [NAVBAR] Iniciando actualización...');
  
  try {
    // Verificar que los elementos existen
    const elementos = {
      usdCompra: document.getElementById('navbar-usd-compra'),
      usdVenta: document.getElementById('navbar-usd-venta'),
      eurCompra: document.getElementById('navbar-eur-compra'),
      eurVenta: document.getElementById('navbar-eur-venta')
    };
    
    console.log('🎯 [NAVBAR] Verificando elementos DOM...');
    for (const [key, elem] of Object.entries(elementos)) {
      console.log(`   ${key}:`, elem ? '✅ OK' : '❌ NO ENCONTRADO');
    }
    
    // Si algún elemento no existe, reintentar en 1 segundo
    if (Object.values(elementos).some(elem => !elem)) {
      console.warn('⚠️ [NAVBAR] Algunos elementos no están listos, reintentando...');
      setTimeout(actualizarTipoCambio, 1000);
      return;
    }
    
    // Obtener datos de la API
    console.log('🌐 [NAVBAR] Consultando API...');
  const response = await fetch('/php/tipo_cambio_popular.php');
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    const data = await response.json();
    console.log('📦 [NAVBAR] Respuesta completa:', data);
    
    if (data && data.data && data.data.success && data.data.data) {
      const rates = data.data.data;
      console.log('💰 [NAVBAR] Datos extraídos:', rates);
      
      // Actualizar variables globales para compatibilidad con modal
      if (typeof window.tcBancoPopular === 'undefined') {
        window.tcBancoPopular = {};
      }
      window.tcBancoPopular.compra = rates.compra;
      window.tcBancoPopular.venta = rates.venta;
      
      // Actualizar USD en navbar
      elementos.usdCompra.textContent = `₡${rates.compra}`;
      elementos.usdVenta.textContent = `₡${rates.venta}`;
      
      // Calcular EUR (USD + 2% como en el modal)
      const eurCompra = Math.round(rates.compra * 1.02);
      const eurVenta = Math.round(rates.venta * 1.02);
      
      elementos.eurCompra.textContent = `₡${eurCompra}`;
      elementos.eurVenta.textContent = `₡${eurVenta}`;
      
      // Actualizar variables globales del navbar
      window.tipoCambioNavbar = {
        usd: { compra: rates.compra, venta: rates.venta },
        eur: { compra: eurCompra, venta: eurVenta }
      };
      
      console.log('✅ [NAVBAR] Actualizado exitosamente:', {
        usd: `₡${rates.compra}/₡${rates.venta}`,
        eur: `₡${eurCompra}/₡${eurVenta}`
      });
      
      // Disparar evento personalizado para que otros componentes se actualicen
      window.dispatchEvent(new CustomEvent('tipoCambioActualizado', {
        detail: {
          usd: { compra: rates.compra, venta: rates.venta },
          eur: { compra: eurCompra, venta: eurVenta }
        }
      }));
      
    } else {
      console.error('❌ [NAVBAR] Estructura de datos inválida:', data);
      throw new Error('Datos inválidos de la API');
    }
    
  } catch (error) {
    console.error('❌ [NAVBAR] Error:', error);
    
    // Marcar como error
    ['navbar-usd-compra', 'navbar-usd-venta', 'navbar-eur-compra', 'navbar-eur-venta'].forEach(id => {
      const elem = document.getElementById(id);
      if (elem) elem.textContent = 'N/A';
    });
  }
}

// Función para abrir conversor
function abrirConversor() {
  // Esperar a que el modal esté cargado
  const modal = document.getElementById('modal-conversion');
  if (modal && typeof mostrarModalConversion === 'function') {
    mostrarModalConversion();
  } else {
    // Si el modal no está disponible, recargar el fragmento y luego abrir
    if (typeof cargarModalConversion === 'function') {
      cargarModalConversion(() => {
        if (typeof mostrarModalConversion === 'function') {
          mostrarModalConversion();
        } else {
          window.location.href = 'tipo-cambio.html';
        }
      });
    } else {
      window.location.href = 'tipo-cambio.html';
    }
  }
}

// Inicialización
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', function() {
    console.log('📋 [NAVBAR] DOM ready, iniciando...');
    setTimeout(actualizarTipoCambio, 500);
  });
} else {
  console.log('📋 [NAVBAR] DOM ya listo, iniciando inmediatamente...');
  setTimeout(actualizarTipoCambio, 100);
}

// Función global para forzar actualización
window.forzarActualizacionNavbar = function() {
  console.log('🔧 [NAVBAR] Función forzar actualización llamada');
  actualizarTipoCambio();
};

// Función global para verificar estado
window.verificarEstadoNavbar = function() {
  console.log('🔍 [NAVBAR] Verificando estado...');
  console.log('   - forzarActualizacionNavbar disponible:', typeof window.forzarActualizacionNavbar === 'function');
  console.log('   - actualizarTipoCambio disponible:', typeof actualizarTipoCambio === 'function');
  console.log('   - tipoCambioNavbar:', window.tipoCambioNavbar);
  console.log('   - tcBancoPopular:', window.tcBancoPopular);
  
  const elementos = ['navbar-usd-compra', 'navbar-usd-venta', 'navbar-eur-compra', 'navbar-eur-venta'];
  elementos.forEach(id => {
    const elem = document.getElementById(id);
    console.log(`   - ${id}:`, elem ? elem.textContent : 'NO ENCONTRADO');
  });
};

// Actualizar cada 5 minutos
setInterval(actualizarTipoCambio, 5 * 60 * 1000);

console.log('✅ [NAVBAR] Script configurado completamente');
console.log('🔧 [NAVBAR] Funciones globales registradas:');
console.log('   - window.forzarActualizacionNavbar:', typeof window.forzarActualizacionNavbar);
console.log('   - window.verificarEstadoNavbar:', typeof window.verificarEstadoNavbar);
</script>
