<!-- Modal de Conversi√≥n de Monedas -->
<div id="modal-conversion" class="modal fade" tabindex="-1" aria-labelledby="modalConversionLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="modalConversionLabel">üí± Conversor de Monedas</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Tipo de cambio actual -->
        <div class="row mb-4">
          <div class="col-md-6">
            <div class="card bg-light">
              <div class="card-body text-center">
                <h6 class="card-title">üíµ USD - D√≥lar</h6>
                <div class="d-flex justify-content-between">
                  <div>
                    <small class="text-muted">Compra</small><br>
                    <span id="modal-usd-compra" class="fw-bold text-success">‚Ç°--</span>
                  </div>
                  <div>
                    <small class="text-muted">Venta</small><br>
                    <span id="modal-usd-venta" class="fw-bold text-danger">‚Ç°--</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card bg-light">
              <div class="card-body text-center">
                <h6 class="card-title">üí∂ EUR - Euro</h6>
                <div class="d-flex justify-content-between">
                  <div>
                    <small class="text-muted">Compra</small><br>
                    <span id="modal-eur-compra" class="fw-bold text-success">‚Ç°--</span>
                  </div>
                  <div>
                    <small class="text-muted">Venta</small><br>
                    <span id="modal-eur-venta" class="fw-bold text-danger">‚Ç°--</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Conversor -->
        <div class="card">
          <div class="card-header bg-secondary text-white">
            <h6 class="mb-0">üîÑ Calculadora de Conversi√≥n</h6>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <label class="form-label">Desde:</label>
                <div class="input-group mb-3">
                  <input type="number" id="cantidad-origen" class="form-control" placeholder="0.00" min="0" step="0.01">
                  <select id="moneda-origen" class="form-select">
                    <option value="CRC">‚Ç° Colones</option>
                    <option value="USD">üíµ USD</option>
                    <option value="EUR">üí∂ EUR</option>
                  </select>
                </div>
              </div>
              <div class="col-md-6">
                <label class="form-label">Hacia:</label>
                <div class="input-group mb-3">
                  <input type="number" id="cantidad-destino" class="form-control" placeholder="0.00" readonly>
                  <select id="moneda-destino" class="form-select">
                    <option value="CRC">‚Ç° Colones</option>
                    <option value="USD">üíµ USD</option>
                    <option value="EUR">üí∂ EUR</option>
                  </select>
                </div>
              </div>
            </div>
            
            <div class="text-center">
              <button type="button" class="btn btn-primary" onclick="realizarConversion()">
                üîÑ Convertir
              </button>
              <button type="button" class="btn btn-secondary ms-2" onclick="intercambiarMonedas()">
                ‚áÑ Intercambiar
              </button>
              <button type="button" class="btn btn-outline-secondary ms-2" onclick="limpiarConversion()">
                üóëÔ∏è Limpiar
              </button>
            </div>

            <!-- Resultado detallado -->
            <div id="resultado-conversion" class="mt-3" style="display: none;">
              <div class="alert alert-info">
                <h6>üìä Detalle de la conversi√≥n:</h6>
                <div id="detalle-conversion"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Historial r√°pido -->
        <div class="card mt-3">
          <div class="card-header">
            <h6 class="mb-0">‚ö° Conversiones R√°pidas</h6>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-4">
                <div class="text-center p-2 border rounded">
                  <small class="text-muted">$100 USD =</small><br>
                  <span id="quick-100usd" class="fw-bold">‚Ç°--</span>
                </div>
              </div>
              <div class="col-md-4">
                <div class="text-center p-2 border rounded">
                  <small class="text-muted">‚Ç¨100 EUR =</small><br>
                  <span id="quick-100eur" class="fw-bold">‚Ç°--</span>
                </div>
              </div>
              <div class="col-md-4">
                <div class="text-center p-2 border rounded">
                  <small class="text-muted">‚Ç°100,000 =</small><br>
                  <span id="quick-100000crc" class="fw-bold">$--</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <small class="text-muted me-auto">
          üìà Datos del BCCR | üïí Actualizado: <span id="ultima-actualizacion">--</span>
        </small>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<script>
// Variables globales para el modal
let tipoCambioModal = {
  usd: { compra: 0, venta: 0 },
  eur: { compra: 0, venta: 0 },
  ultimaActualizacion: null
};

// Funci√≥n para mostrar el modal
function mostrarModalConversion() {
  actualizarTipoCambioModal();
  const modal = new bootstrap.Modal(document.getElementById('modal-conversion'));
  modal.show();
}

// Actualizar tipo de cambio en el modal
async function actualizarTipoCambioModal() {
  try {
    const response = await fetch('/api/tipo-cambio');
    const apiResponse = await response.json();
    
    console.log('üì° Respuesta API modal:', apiResponse);
    
    // La estructura es: { data: { success: true, data: { compra, venta } }, lastUpdate, services }
    if (apiResponse.data && apiResponse.data.success && apiResponse.data.data) {
      const tipoCambioData = apiResponse.data.data;
      
      // USD del BCCR
      tipoCambioModal.usd = {
        compra: tipoCambioData.compra,
        venta: tipoCambioData.venta
      };
      
      // EUR calculado (USD + 2%)
      tipoCambioModal.eur = {
        compra: Math.round(tipoCambioData.compra * 1.02 * 100) / 100,
        venta: Math.round(tipoCambioData.venta * 1.02 * 100) / 100
      };
      
      tipoCambioModal.ultimaActualizacion = new Date().toLocaleString();
      
      console.log('üí± Tipo de cambio actualizado en modal:', tipoCambioModal);
      
      // Actualizar interfaz del modal
      actualizarInterfazModal();
      calcularConversionesRapidas();
    } else {
      console.error('‚ùå Estructura de datos inesperada en modal:', apiResponse);
      throw new Error('Datos no v√°lidos en la respuesta');
    }
  } catch (error) {
    console.error('Error al obtener tipo de cambio para modal:', error);
  }
}

// Actualizar interfaz del modal
function actualizarInterfazModal() {
  document.getElementById('modal-usd-compra').textContent = `‚Ç°${tipoCambioModal.usd.compra.toFixed(0)}`;
  document.getElementById('modal-usd-venta').textContent = `‚Ç°${tipoCambioModal.usd.venta.toFixed(0)}`;
  document.getElementById('modal-eur-compra').textContent = `‚Ç°${tipoCambioModal.eur.compra.toFixed(0)}`;
  document.getElementById('modal-eur-venta').textContent = `‚Ç°${tipoCambioModal.eur.venta.toFixed(0)}`;
  document.getElementById('ultima-actualizacion').textContent = tipoCambioModal.ultimaActualizacion || '--';
}

// Realizar conversi√≥n
function realizarConversion() {
  const cantidadOrigen = parseFloat(document.getElementById('cantidad-origen').value);
  const monedaOrigen = document.getElementById('moneda-origen').value;
  const monedaDestino = document.getElementById('moneda-destino').value;
  
  if (!cantidadOrigen || cantidadOrigen <= 0) {
    alert('Por favor ingrese una cantidad v√°lida');
    return;
  }
  
  if (monedaOrigen === monedaDestino) {
    document.getElementById('cantidad-destino').value = cantidadOrigen.toFixed(2);
    mostrarDetalleConversion(cantidadOrigen, monedaOrigen, cantidadOrigen, monedaDestino, 1);
    return;
  }
  
  let resultado = 0;
  let tasa = 0;
  let tipoOperacion = '';
  
  // Conversiones desde CRC
  if (monedaOrigen === 'CRC') {
    if (monedaDestino === 'USD') {
      tasa = tipoCambioModal.usd.compra;
      resultado = cantidadOrigen / tasa;
      tipoOperacion = 'compra USD';
    } else if (monedaDestino === 'EUR') {
      tasa = tipoCambioModal.eur.compra;
      resultado = cantidadOrigen / tasa;
      tipoOperacion = 'compra EUR';
    }
  }
  // Conversiones desde USD
  else if (monedaOrigen === 'USD') {
    if (monedaDestino === 'CRC') {
      tasa = tipoCambioModal.usd.venta;
      resultado = cantidadOrigen * tasa;
      tipoOperacion = 'venta USD';
    } else if (monedaDestino === 'EUR') {
      // USD a EUR v√≠a CRC
      const colones = cantidadOrigen * tipoCambioModal.usd.venta;
      tasa = tipoCambioModal.eur.compra;
      resultado = colones / tasa;
      tipoOperacion = 'USD‚ÜíCRC‚ÜíEUR';
    }
  }
  // Conversiones desde EUR
  else if (monedaOrigen === 'EUR') {
    if (monedaDestino === 'CRC') {
      tasa = tipoCambioModal.eur.venta;
      resultado = cantidadOrigen * tasa;
      tipoOperacion = 'venta EUR';
    } else if (monedaDestino === 'USD') {
      // EUR a USD v√≠a CRC
      const colones = cantidadOrigen * tipoCambioModal.eur.venta;
      tasa = tipoCambioModal.usd.compra;
      resultado = colones / tasa;
      tipoOperacion = 'EUR‚ÜíCRC‚ÜíUSD';
    }
  }
  
  document.getElementById('cantidad-destino').value = resultado.toFixed(2);
  mostrarDetalleConversion(cantidadOrigen, monedaOrigen, resultado, monedaDestino, tasa, tipoOperacion);
}

// Mostrar detalle de conversi√≥n
function mostrarDetalleConversion(origen, monedaOrigen, destino, monedaDestino, tasa, operacion) {
  const simbolos = { CRC: '‚Ç°', USD: '$', EUR: '‚Ç¨' };
  
  let detalle = `
    <strong>${simbolos[monedaOrigen]}${origen.toLocaleString()} ${monedaOrigen}</strong> = 
    <strong class="text-primary">${simbolos[monedaDestino]}${destino.toLocaleString()} ${monedaDestino}</strong>
  `;
  
  if (operacion && tasa) {
    detalle += `<br><small class="text-muted">Operaci√≥n: ${operacion} | Tasa: ‚Ç°${tasa.toLocaleString()}</small>`;
  }
  
  document.getElementById('detalle-conversion').innerHTML = detalle;
  document.getElementById('resultado-conversion').style.display = 'block';
}

// Intercambiar monedas
function intercambiarMonedas() {
  const origenSelect = document.getElementById('moneda-origen');
  const destinoSelect = document.getElementById('moneda-destino');
  
  const temp = origenSelect.value;
  origenSelect.value = destinoSelect.value;
  destinoSelect.value = temp;
  
  // Intercambiar cantidades si hay valores
  const cantidadOrigen = document.getElementById('cantidad-origen').value;
  const cantidadDestino = document.getElementById('cantidad-destino').value;
  
  if (cantidadDestino) {
    document.getElementById('cantidad-origen').value = cantidadDestino;
    document.getElementById('cantidad-destino').value = '';
    realizarConversion();
  }
}

// Limpiar conversi√≥n
function limpiarConversion() {
  document.getElementById('cantidad-origen').value = '';
  document.getElementById('cantidad-destino').value = '';
  document.getElementById('resultado-conversion').style.display = 'none';
}

// Calcular conversiones r√°pidas
function calcularConversionesRapidas() {
  if (tipoCambioModal.usd.venta > 0) {
    document.getElementById('quick-100usd').textContent = `‚Ç°${(100 * tipoCambioModal.usd.venta).toLocaleString()}`;
    document.getElementById('quick-100000crc').textContent = `$${(100000 / tipoCambioModal.usd.compra).toFixed(2)}`;
  }
  
  if (tipoCambioModal.eur.venta > 0) {
    document.getElementById('quick-100eur').textContent = `‚Ç°${(100 * tipoCambioModal.eur.venta).toLocaleString()}`;
  }
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
  // Auto-conversi√≥n al escribir
  document.getElementById('cantidad-origen').addEventListener('input', function() {
    if (this.value) {
      realizarConversion();
    } else {
      document.getElementById('cantidad-destino').value = '';
      document.getElementById('resultado-conversion').style.display = 'none';
    }
  });
  
  // Auto-conversi√≥n al cambiar monedas
  document.getElementById('moneda-origen').addEventListener('change', function() {
    if (document.getElementById('cantidad-origen').value) {
      realizarConversion();
    }
  });
  
  document.getElementById('moneda-destino').addEventListener('change', function() {
    if (document.getElementById('cantidad-origen').value) {
      realizarConversion();
    }
  });
});
</script>