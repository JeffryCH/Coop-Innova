<nav class="navbar navbar-expand-lg navbar-light bg-light">
  <div class="container">
    <a class="navbar-brand fw-bold" href="index.html">🏦 Coop-Innova</a>
    
    <!-- Tipo de cambio en navbar -->
    <div id="tipo-cambio-navbar" class="d-flex align-items-center ms-3" style="font-size:0.85rem;">
      <div class="tipo-cambio-container d-flex gap-3">
        <div class="tipo-cambio-item" style="background:#e3f2fd; padding:4px 8px; border-radius:8px; border:1px solid #1976d2;">
          <span style="color:#1976d2; font-weight:600;">💵 USD:</span>
          <span id="navbar-usd-compra" style="color:#2e7d32; font-weight:500;">--</span> /
          <span id="navbar-usd-venta" style="color:#d32f2f; font-weight:500;">--</span>
        </div>
        <div class="tipo-cambio-item" style="background:#f3e5f5; padding:4px 8px; border-radius:8px; border:1px solid #7b1fa2;">
          <span style="color:#7b1fa2; font-weight:600;">💶 EUR:</span>
          <span id="navbar-eur-compra" style="color:#2e7d32; font-weight:500;">--</span> /
          <span id="navbar-eur-venta" style="color:#d32f2f; font-weight:500;">--</span>
        </div>
        <button id="btn-conversor" class="btn btn-sm btn-outline-primary" style="padding:2px 8px; font-size:0.8rem;" onclick="abrirConversor()">
          💱 Convertir
        </button>
      </div>
    </div>

    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#menu">
      <span class="navbar-toggler-icon"></span>
    </button>
    
    <div class="collapse navbar-collapse" id="menu">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link" href="index.html">🏠 Inicio</a></li>
        <li class="nav-item"><a class="nav-link" href="servicios.html">🛠️ Servicios</a></li>
        <li class="nav-item"><a class="nav-link" href="solicitar_credito.html">💳 Solicitar Crédito</a></li>
        <li class="nav-item"><a class="nav-link" href="movimientos.html">💰 Movimientos</a></li>
        <li class="nav-item"><a class="nav-link" href="ver_perfil.html">👤 Ver Perfil</a></li>
        <li class="nav-item"><a class="nav-link" href="tipo-cambio.html">💱 Tipo de Cambio</a></li>
        <li class="nav-item"><a class="nav-link" href="registro.html">📝 Registro</a></li>
        <li class="nav-item"><a class="nav-link" href="contacto.html">📞 Contacto</a></li>
        <li class="nav-item">
          <button class="btn btn-primary btn-sm ms-2" onclick="abrirConversor()">🔄 Conversor</button>
        </li>
      </ul>
    </div>
  </div>
</nav>

<!-- Estilos para el navbar -->
<style>
.tipo-cambio-container {
  animation: fadeIn 1s ease-in;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.tipo-cambio-item {
  transition: all 0.3s ease;
}

.tipo-cambio-item:hover {
  transform: scale(1.05);
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

@media (max-width: 768px) {
  #tipo-cambio-navbar {
    display: none !important;
  }
}
</style>

<!-- Script para actualizar tipo de cambio en navbar -->
<script>
let tipoCambioNavbar = {
  usd: { compra: 0, venta: 0 },
  eur: { compra: 0, venta: 0 }
};

async function actualizarTipoCambioNavbar() {
  console.log('🔄 Iniciando actualización de tipo de cambio en navbar...');
  
  try {
    const response = await fetch('/api/tipo-cambio');
    console.log('📡 Respuesta HTTP recibida:', response.status);
    
    const apiResponse = await response.json();
    console.log('� Respuesta completa de la API:', apiResponse);
    
    // Verificar elementos del DOM
    const elementos = [
      'navbar-usd-compra', 'navbar-usd-venta', 
      'navbar-eur-compra', 'navbar-eur-venta'
    ];
    
    elementos.forEach(id => {
      const elem = document.getElementById(id);
      console.log(`🎯 Elemento ${id}:`, elem ? 'ENCONTRADO' : 'NO ENCONTRADO');
    });
    
    // La estructura es: { data: { success: true, data: { compra, venta } }, lastUpdate, services }
    if (apiResponse.data && apiResponse.data.success && apiResponse.data.data) {
      const tipoCambioData = apiResponse.data.data;
      console.log('💰 Datos de tipo de cambio extraídos:', tipoCambioData);
      
      // USD del BCCR
      tipoCambioNavbar.usd = {
        compra: tipoCambioData.compra,
        venta: tipoCambioData.venta
      };
      
      // EUR calculado (USD + 2%)
      tipoCambioNavbar.eur = {
        compra: Math.round(tipoCambioData.compra * 1.02 * 100) / 100,
        venta: Math.round(tipoCambioData.venta * 1.02 * 100) / 100
      };
      
      console.log('💱 Tipo de cambio calculado:', tipoCambioNavbar);
      
      // Actualizar elementos del navbar
      const usdCompraElem = document.getElementById('navbar-usd-compra');
      const usdVentaElem = document.getElementById('navbar-usd-venta');
      const eurCompraElem = document.getElementById('navbar-eur-compra');
      const eurVentaElem = document.getElementById('navbar-eur-venta');
      
      if (usdCompraElem) {
        const valor = `₡${tipoCambioNavbar.usd.compra.toFixed(0)}`;
        usdCompraElem.textContent = valor;
        console.log('✅ USD Compra actualizado:', valor);
      }
      
      if (usdVentaElem) {
        const valor = `₡${tipoCambioNavbar.usd.venta.toFixed(0)}`;
        usdVentaElem.textContent = valor;
        console.log('✅ USD Venta actualizado:', valor);
      }
      
      if (eurCompraElem) {
        const valor = `₡${tipoCambioNavbar.eur.compra.toFixed(0)}`;
        eurCompraElem.textContent = valor;
        console.log('✅ EUR Compra actualizado:', valor);
      }
      
      if (eurVentaElem) {
        const valor = `₡${tipoCambioNavbar.eur.venta.toFixed(0)}`;
        eurVentaElem.textContent = valor;
        console.log('✅ EUR Venta actualizado:', valor);
      }
      
    } else {
      console.error('❌ Estructura de datos inesperada:', apiResponse);
      console.error('   - apiResponse.data:', apiResponse.data);
      console.error('   - apiResponse.data?.success:', apiResponse.data?.success);
      console.error('   - apiResponse.data?.data:', apiResponse.data?.data);
      throw new Error('Datos no válidos en la respuesta');
    }
  } catch (error) {
    console.error('❌ Error al obtener tipo de cambio para navbar:', error);
    // Mostrar error en navbar
    ['navbar-usd-compra', 'navbar-usd-venta', 'navbar-eur-compra', 'navbar-eur-venta'].forEach(id => {
      const elem = document.getElementById(id);
      if (elem) {
        elem.textContent = 'N/A';
        console.log(`❌ ${id} marcado como N/A por error`);
      }
    });
  }
}

// Función para abrir el conversor (se definirá en cada página)
function abrirConversor() {
  if (typeof mostrarModalConversion === 'function') {
    mostrarModalConversion();
  } else if (document.getElementById('modal-conversion')) {
    document.getElementById('modal-conversion').style.display = 'block';
  } else {
    // Redirigir a página de tipo de cambio si no hay modal
    window.location.href = 'tipo-cambio.html';
  }
}

// Inicializar al cargar
document.addEventListener('DOMContentLoaded', function() {
  console.log('🚀 DOM cargado, iniciando tipo de cambio navbar...');
  
  // Esperar un poco para asegurar que el navbar esté completamente renderizado
  setTimeout(() => {
    console.log('⏰ Timeout ejecutado, llamando actualizarTipoCambioNavbar...');
    actualizarTipoCambioNavbar();
  }, 500);
  
  // Actualizar cada 5 minutos
  setInterval(() => {
    console.log('🔄 Intervalo ejecutado, actualizando tipo de cambio...');
    actualizarTipoCambioNavbar();
  }, 5 * 60 * 1000);
});

// También agregar una función global para llamar manualmente
window.forzarActualizacionNavbar = function() {
  console.log('🔧 Actualización manual forzada...');
  actualizarTipoCambioNavbar();
};
</script>